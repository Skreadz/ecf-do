:doctype: book
:toc-title: Table des matières
:toc:
:sectnums:
:toclevels: 3
:sectnumlevels: 4
:last-update-label: Dernière mise à jour
:imagesdir: ./images
:classification: Interne
:author: Dylan Ortega
:client: Formation DevOps
:projet: Déploiement Kubernetes Worker
:revnumber: 1.0
:revdate: 2024-06-09

= Rôle Ansible `kube_worker`

== Présentation

Ce rôle Ansible permet de joindre automatiquement un nœud worker à un cluster Kubernetes existant. Il s’appuie sur la commande `kubeadm join` générée par le nœud maître et configure les prérequis système nécessaires.

== Prérequis

* Système Linux compatible (Debian/Ubuntu ou RHEL/CentOS)
* Accès root ou sudo pour l’utilisateur `dortega`
* Le cluster maître doit être initialisé et accessible
* Modules Ansible requis : `ansible.builtin`, `kubernetes.core`
* La variable `join_command` doit être fournie par le master (via facts ou inventaire)

== Variables du rôle

[cols="1,1,2",options="header"]
|===
|Nom
|Valeur par défaut
|Description

|`k8s_version`
|`1.33`
|Version de Kubernetes à préparer

|`pod_network_cidr`
|`192.168.0.0/16`
|CIDR du réseau de pods

|`os_family`
|Détecté automatiquement
|Famille du système d’exploitation (debian, redhat, etc.)

|`kube_config_dir`
|`/home/dortega/.kube`
|Répertoire de configuration kubeconfig pour l’utilisateur

|`cni_plugin`
|`calico`
|Plugin CNI à préparer (pour compatibilité)

|`cni_version`
|`3.30.0`
|Version du plugin CNI

|`disable_swap`
|`true`
|Désactive le swap sur le nœud

|`enable_modules`
|`[br_netfilter, overlay]`
|Modules kernel à charger pour Kubernetes

|`join_command`
|*Obligatoire*
|Commande `kubeadm join` générée par le master pour joindre le cluster
|===

== Dépendances

Aucune dépendance externe obligatoire. S’assurer que les collections Ansible nécessaires sont installées.

== Exemple d’utilisation

[source,yaml]
----
- hosts: workers
  become: true
  roles:
    - role: kube_worker
      vars:
        join_command: "kubeadm join 10.0.0.1:6443 --token ... --discovery-token-ca-cert-hash ..."
----

== Tâches principales

. Chargement et persistance des modules kernel requis
. Désactivation du swap (immédiat et permanent)
. Installation des paquets système nécessaires (Docker, Kubernetes, etc.)
. Configuration des dépôts APT/YUM pour Docker et Kubernetes
. Installation de Docker, cri-dockerd et dépendances
. Exécution de la commande `kubeadm join` pour rattacher le worker au cluster

== Bonnes pratiques

* Toujours spécifier une version exacte pour Kubernetes et le CNI
* Utiliser un utilisateur dédié (`dortega`) pour la gestion du cluster
* S’assurer que la commande `join_command` est valide et à jour

== Historique des versions

[cols="1,2,2",options="header"]
|===
|Version |Date |Commentaires
|1.0 |2024-06-09 |Version initiale
|===

Dernière mise à jour : {revdate}
